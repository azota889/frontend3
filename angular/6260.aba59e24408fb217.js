"use strict";(self.webpackChunkBalacoClient=self.webpackChunkBalacoClient||[]).push([[6260],{17997:(R,P,o)=>{o.d(P,{H:()=>g});var x=o(65879),G=o(46558),w=o(97151),z=o(61419),v=o(41385),N=o(38228);let g=(()=>{class f{constructor(r,n,h,i,m){this.commonService=r,this.shareFileFlutterService=n,this.encryptService=h,this.formatAnswerSheetService=i,this.exportExcelService=m}exportFileNameOfStudentCode(r,n,h){return 100==r&&(n=""),this.commonService.createFileNameExportFile(["DanhSachSBD"+(n?"_"+n:"")+"_"+this.encryptService.createMd5(h).substring(0,6)])+".xlsx"}chooseAnswerSheetTemplate(r,n,h,i,m,D){return 12==n?r.createA5AnswerSheetFullA4_50(D??50):13==n?r.createA4AnswerSheet_35hh(D??50):14==n?r.createA6AnswerSheetFullA4_20(D??20):15==n||16==n||17==n||18==n?r.createTrueFalseAnswerSheet():r.createAzotaAnswerSheet_A4(D??120)}exportFileNameOfAnswerSheet(r,n,h){var i="";return 100==r&&(n=""),(0==r||100==r)&&(i=this.commonService.createFileNameExportFile(["PhieuTL_"+h+(n?"_"+n:"")])),i}exportFileNameOfAnswerExcelOffline(r,n,h){var i="";return 100==r&&(n=""),(0==r||100==r)&&(i=this.commonService.createFileNameExportFile(["DapAn_"+(n?"_"+n:"")])),i}exportFileNameOfRawExam(r,n,h){var i="";return 100==r&&(n=""),(0==r||100==r)&&(i=this.commonService.createFileNameExportFile([(n?"_"+n:"")+"_"+this.encryptService.createMd5(h).substring(0,6)])),i}exportFileNameOfExamOffline(r,n,h,i){var m="";return 100==r&&(n=""),(0==r||100==r)&&(m=this.commonService.createFileNameExportFile([(i?this.formatAnswerSheetService.formatOfflineExamHashIdToNumber(i,3)+"_":"")+h+(n?"_"+n:"")])),m}printStudentCode(r,n){var h=[];let i=this.commonService.myClone(n);for(let m=0;m<i.length;m++)h.push({code:i[m].code??0,fullName:i[m]?.fullName??"",birthday:i[m]?.birthday??"",className:i[m].classroomName??""});this._exportExcelForCodeNumber(r,h)}_exportExcelForCodeNumber(r,n){let h=this.exportFileNameOfStudentCode(0,r?.name??"",r?.hashId??"");const i=this.exportExcelService.exportExcelForCodeNumber(n);this.shareFileFlutterService.shareFileWithBlob(i,h)}}return f.\u0275fac=function(r){return new(r||f)(x.LFG(G.z),x.LFG(w.g),x.LFG(z.j),x.LFG(v.j),x.LFG(N.L))},f.\u0275prov=x.Yz7({token:f,factory:f.\u0275fac,providedIn:"root"}),f})()},56260:(R,P,o)=>{o.d(P,{F:()=>U});var x=o(85965),w=o(8720),z=o(70731),v=o(89156),N=o(89745),g=o(79617),f=o(65879),y=o(36668),r=o(32965),n=o(46558),h=o(78953),i=o(19662),m=o(17997),D=o(41385),B=o(97151);let U=(()=>{class O{constructor(s,t,c,a,S,M,e,l){this.docxService=s,this.cdnService=t,this.commonService=c,this.userService=a,this.questionRenderService=S,this.printAnswersheetService=M,this.formatAnswerSheetService=e,this.shareFileFlutterService=l,this.configRenderService=new w.v,this.saveLoadingMsg="",this.isAnsDetail=!1,this.isEnableDebug=!1,this.zipper=new x,this.countRetryLoadJS=0}loadScriptAction(){return new Promise((s,t)=>{this.commonService.loadScriptPromises([{source:this.cdnService.registerJsCdn("min.azota_docx_script"),name:"min.azota_docx_script"}]).then(()=>{setTimeout(()=>{window.hasOwnProperty("azotaDocx")?typeof azotaDocx<"u"&&azotaDocx?s(!0):t(new Error("lang_core_lib_not_load")):(this.countRetryLoadJS++,this.countRetryLoadJS>3?t(new Error("lang_core_lib_not_load")):s(this.loadScriptAction()))},1e3)})})}convertAnswerQuestion(s){let t=[];return s.forEach(c=>{let a="<b>     "+(c.alpha?c.alpha:c.key)+".</b> "+(0,g.uG)(c.content);t.push(a)}),t}getDataForExportDocxApi(s,t,c){let a=[],S=1;if(c){let e=this.commonService.myTranslateInstant("lang_cms_publish_test_exam");a.push({content:`<b> ${e} `+this.formatAnswerSheetService.formatOfflineExamHashIdToNumber(c,3)+".</b>",answers:[]})}let M=this.expandInfoParse?.label??this.commonService.myTranslateInstant("lang_auto_cau");return t.forEach(e=>{1!==s.hideGroupQuestion&&e.groupInfo?.isFirstInGroup&&e.groupInfo.groupContent&&a.push({content:e.groupInfo.groupContent,answers:[]}),this.isEnableDebug&&a.push({content:` <br/><br/><br/>*** <b>Question ID: ${e.id}</b> ***`,answers:[]});let l={content:`<b>${M} `+(S+(s.startQuestionIndex??1)-1)+".</b> "+(e.content?.includes("<img")?"<br>":"")+(0,g.uG)(e.content),answers:this.convertAnswerQuestion(e.answers??[])};if(S++,a.push(l),this.isAnsDetail){if(e.answerResult){let _=[];if(e.answerResult.forEach(u=>{let p=u;const d=e.answers?.find(A=>A.key===u);d&&(p=d.alpha??p),_.push(p)}),5==e.answerType){let u="";e.answers.forEach((p,d)=>{u+=`${p.key} - ${_.includes(p.key)?this.commonService.myTranslateInstant("lang_auto_dung"):this.commonService.myTranslateInstant("lang_auto_sai")}${d==e.answers.length-1?"":" | "}`}),a.push({content:`<b>${this.commonService.myTranslateInstant("lang_auto_dap_an")}</b>: ${u}`,answers:[]})}else a.push({content:`<b>${this.commonService.myTranslateInstant("lang_auto_dap_an_dung")}</b>: ${_.join(" | ")}`,answers:[]})}e.help&&a.push({content:`<b>${this.commonService.myTranslateInstant("lang_auto_giai_thich_chi_tiet_upper")}</b>: ${e.help}`,answers:[]})}this.isEnableDebug&&a.push({content:"*** *************** .. **************** ***<br/><br/><br/>",answers:[]})}),a}itemConverterCaller(s,t,c,a,S){return new Promise((M,e)=>{this.questionRenderService.parseRenderQuestions(s.listQuestion,l=>{this.saveLoadingMsg.includes(")")||(this.changeMsg?this.changeMsg(this.saveLoadingMsg+Math.floor(l)+"%"):v.G.changeMsgLoadingEffect(this.saveLoadingMsg+Math.floor(l)+"%"))},this.configRenderService,void 0,!0,S).then(l=>{let _=[];_.push({content:g.Ip.makeHeaderTable([g.Ip.createLineCenterBold(t.schoolName?t.schoolName:"")],[g.Ip.createLineCenterBold(t.examName??""),g.Ip.createLineCenterBold(t.subject??""),g.Ip.createLineCenterItalicized(t.examMinutes??""),g.Ip.createLineCenterItalicized("-------------------------")],!1),answers:[]}),_.push({content:g.Ip.createLineBold(this.commonService.myTranslateInstant("lang_auto_ho_ten_thi_sinh_offline")??"").outerHTML,answers:[]}),_.push({content:g.Ip.createLineBold(this.commonService.myTranslateInstant("lang_auto_so_bao_danh_offline")??"").outerHTML,answers:[]}),_=_.concat(this.getDataForExportDocxApi(a,l,s.offlineExamMixQuestionObj?s.offlineExamMixQuestionObj.hashId??0:void 0)),typeof azotaDocx<"u"&&azotaDocx?this.docxService.exportToDocxBinary(_,{isHeadless:!0},(u,p,d)=>{}).then(u=>{M({userObj:c,data:u,input:_,additionParams:t,offlineExamMixQuestionObj:s.offlineExamMixQuestionObj})}):e(new Error("C\xf3 l\u1ed7i x\u1ea3y ra trong qu\xe1 tr\xecnh x\u1eed l\xfd d\u1eef li\u1ec7u (Kh\xf4ng t\u1ea3i \u0111\u01b0\u1ee3c th\u01b0 vi\u1ec7n). Vui l\xf2ng F5 v\xe0 th\u1eed l\u1ea1i sau!"))}).catch(l=>{e(new Error(l[0].message))})})}masterConverterCaller(s,t,c,a,S,M){return new Promise((e,l)=>{const _=this.userService.getUserObj();let u=this.commonService.myTranslateInstant("lang_testbank_utils_footer_information_school")?.toLowerCase(),p=this.commonService.myTranslateInstant("lang_auto_docx_mon_thi")?.toLowerCase(),d=this.commonService.myTranslateInstant("lang_auto_docx_bai_thi")?.toLowerCase(),A=this.commonService.myTranslateInstant("lang_testbank_tested_list_time_homework"),C=this.commonService.myTranslateInstant("lang_core_khong_ke_thoi_gian_giao_de"),F=this.commonService.myTranslateInstant("lang_testbank_tested_list_minute"),b=this.commonService.myTranslateInstant("lang_auto_khong_gioi_han");const T=new z.Q(1,{function:(I,E)=>{this.saveLoadingMsg=`${this.commonService.myTranslateInstant("lang_auto_dang_tao_tep_tin_cho_de_thi")} ${E<=1?"":`(${I}/${E}) `}`,this.changeMsg?this.changeMsg(this.saveLoadingMsg):v.G.changeMsgLoadingEffect(this.saveLoadingMsg)}});s.forEach(I=>{T.addTask(this,this.itemConverterCaller,[I,{schoolName:a?.nameSchool??`{${u}}`,subject:a?.nameSubject??`{${p}}`,examName:t.name??`{${d}}`,examMinutes:t.minutes&&t.minutes>0?`${A}: `+t.minutes+` ${F} (${C})`:` ${A}: ${b}`,templateType:S??0,numberOfQuestion:I.listQuestion.length,examId:I.offlineExamMixQuestionObj?.hashId??0},_,t,M])}),T.start().then(I=>{if(I.errs.length>0)l(I.errs[0]);else if(1===I.datas.length){const E=I.datas[0],L=new Blob([E.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});let W=this.createNameExam(t,c,E.offlineExamMixQuestionObj);this.shareFileFlutterService.shareFileWithBlob(L,W),e()}else I.datas.forEach(E=>{let L=this.createNameExam(t,c,E.offlineExamMixQuestionObj);L=this.replaceAllString(L,"/","_"),this.zipper.file("DOCS/"+L,E.data)}),setTimeout(()=>{this.zipper.generateAsync({type:"blob"}).then(E=>{let L=this.commonService.createFileNameExportFile([t.name??"azota"])+"_offline_test.zip";this.shareFileFlutterService.shareFileWithBlob(E,L),e()},E=>{l(E)})},200)})})}replaceAllString(s,t,c){for(;s.includes(t);)s=s.replace(t,c);return s}createNameExam(s,t,c){return t?this.printAnswersheetService.exportFileNameOfExamOffline(0,s.name??"",t?.hashId??"",c?.hashId??0)+".docx":this.printAnswersheetService.exportFileNameOfRawExam(0,s.name??"",s.hashId??"")+".docx"}downloadExam(s,t,c,a,S,M,e,l,_,u,p){return new Promise((d,A)=>{this.isAnsDetail=s,this.isEnableDebug=!!u,this.expandInfoParse=this.commonService.castJsonToObj(t.expandInfo??"{}"),this.changeMsg=_,this.loadScriptAction().then(C=>{C?this.masterConverterCaller([{listQuestion:S,offlineExamMixQuestionObj:a}],t,c,M,e,p).then(()=>{this.zipper=new x,l?l(10):v.G.closeLoadingEffect(10),d()}).catch(F=>{v.G.closeLoadingEffect(10),A(F)}):(l?l(10):v.G.closeLoadingEffect(10),A(new Error("lang_core_lib_not_load")))}).catch(()=>{l?l(10):v.G.closeLoadingEffect(10),A(new Error("lang_core_lib_not_load"))})})}downloadExamObjs(s,t,c,a,S,M,e,l,_,u){return new Promise((p,d)=>{this.isAnsDetail=s,this.isEnableDebug=!!_,this.expandInfoParse=this.commonService.castJsonToObj(t.expandInfo??"{}"),this.changeMsg=l,this.loadScriptAction().then(A=>{if(A){let C=!0;const F=[];a.forEach(b=>{let T=this.commonService.castJsonToClassObjs(N.v,JSON.stringify(b.mixQuestions??[]))??[];T.length>0?F.push({listQuestion:T,offlineExamMixQuestionObj:b}):C=!1}),C?this.masterConverterCaller(F,t,c,S,M,u).then(()=>{this.zipper=new x,e?e(10):v.G.closeLoadingEffect(10),p()}).catch(b=>{e?e(10):v.G.closeLoadingEffect(10),d(b)}):(e?e(10):v.G.closeLoadingEffect(10),d(new Error("lang_testbank_exam_is_invalid_condition")))}else e?e(10):v.G.closeLoadingEffect(10),d(new Error("lang_core_lib_not_load"))}).catch(()=>{e?e(10):v.G.closeLoadingEffect(10),d(new Error("lang_core_lib_not_load"))})})}}return O.\u0275fac=function(s){return new(s||O)(f.LFG(y.n),f.LFG(r.E),f.LFG(n.z),f.LFG(h.U),f.LFG(i.h),f.LFG(m.H),f.LFG(D.j),f.LFG(B.g))},O.\u0275prov=f.Yz7({token:O,factory:O.\u0275fac,providedIn:"root"}),O})()}}]);