"use strict";(self.webpackChunkBalacoClient=self.webpackChunkBalacoClient||[]).push([[1513],{7743:(W,y,i)=>{i.d(y,{c:()=>T});var T=function(s){return s[s.templateOriginalA4=20]="templateOriginalA4",s[s.templateA5Full50=22]="templateA5Full50",s[s.templateA4Essay=21]="templateA4Essay",s[s.templateA6Full20=23]="templateA6Full20",s[s.templateTrueFalseA4=15]="templateTrueFalseA4",s[s.templateTrueFalseEssayA4=16]="templateTrueFalseEssayA4",s[s.templateTrueFalseA5=17]="templateTrueFalseA5",s[s.templateTrueFalseA6=18]="templateTrueFalseA6",s[s.templateA4WithFax=19]="templateA4WithFax",s[s.templateA4WithFaxV2=190]="templateA4WithFaxV2",s[s.templateTrueFalseA4WithColor=150]="templateTrueFalseA4WithColor",s[s.templateA4WithColorNew=200]="templateA4WithColorNew",s}(T||{})},42032:(W,y,i)=>{i.d(y,{Q:()=>F});var T=i(7743),s=i(26860),w=i(25693),K=i(10296),R=i(50244),C=i(84708),B=i(67638);let F=(()=>{class g{constructor(r,t,m,o,M){this.commonService=r,this.shareFileFlutterService=t,this.encryptService=m,this.formatAnswerSheetService=o,this.exportExcelService=M,this.allAnswerSheet=T.c}exportFileNameOfStudentCode(r,t,m){return 100==r&&(t=""),this.commonService.createFileNameExportFile(["DanhSachSBD"+(t?"_"+t:"")+"_"+this.encryptService.createMd5(m).substring(0,6)])+".xlsx"}chooseAnswerSheetTemplate(r,t,m,o,M,S){return t==this.allAnswerSheet.templateA5Full50?r.createA5AnswerSheetFullA4_50(S??50):t==this.allAnswerSheet.templateA4Essay?r.createA4AnswerSheet_35hh(S??50):t==this.allAnswerSheet.templateA6Full20?r.createA6AnswerSheetFullA4_20(S??20):t==this.allAnswerSheet.templateTrueFalseA4||t==this.allAnswerSheet.templateTrueFalseA4WithColor||t==this.allAnswerSheet.templateTrueFalseEssayA4||t==this.allAnswerSheet.templateTrueFalseA5||t==this.allAnswerSheet.templateTrueFalseA6||t==this.allAnswerSheet.templateA4WithFax||t==this.allAnswerSheet.templateA4WithFaxV2?r.createTrueFalseAnswerSheet():r.createAzotaAnswerSheet_A4(S??120)}exportFileNameOfAnswerSheet(r,t,m){var o="";return 100==r&&(t=""),(0==r||100==r)&&(o=this.commonService.createFileNameExportFile(["PhieuTL_"+m+(t?"_"+t:"")])),o}exportFileNameOfAnswerExcelOffline(r,t,m){var o="";return 100==r&&(t=""),(0==r||100==r)&&(o=this.commonService.createFileNameExportFile(["DapAn_"+(t?"_"+t:"")])),o}exportFileNameOfRawExam(r,t,m){var o="";return 100==r&&(t=""),(0==r||100==r)&&(o=this.commonService.createFileNameExportFile([(t?"_"+t:"")+"_"+this.encryptService.createMd5(m).substring(0,6)])),o}exportFileNameOfExamOffline(r,t,m,o){var M="";return 100==r&&(t=""),(0==r||100==r)&&(M=this.commonService.createFileNameExportFile([(o?this.formatAnswerSheetService.formatOfflineExamHashIdToNumber(o,3)+"_":"")+m+(t?"_"+t:"")])),M}printStudentCode(r,t){var m=[];let o=this.commonService.myClone(t);for(let M=0;M<o.length;M++)m.push({code:o[M].code??0,fullName:o[M]?.fullName??"",birthday:o[M]?.birthday??"",className:o[M].classroomName??""});this._exportExcelForCodeNumber(r,m)}_exportExcelForCodeNumber(r,t){let m=this.exportFileNameOfStudentCode(0,r?.name??"",r?.hashId??"");const o=this.exportExcelService.exportExcelForCodeNumber(t);this.shareFileFlutterService.shareFileWithBlob(o,m)}static#e=this.\u0275fac=function(t){return new(t||g)(s.KVO(w.R),s.KVO(K.R),s.KVO(R.v),s.KVO(C.e),s.KVO(B.x))};static#t=this.\u0275prov=s.jDH({token:g,factory:g.\u0275fac,providedIn:"root"})}return g})()},91513:(W,y,i)=>{i.d(y,{c:()=>V});var T=i(73014),s=i(91478),K=i(65106),R=i(5382),C=i(18148),B=i(25539),F=i(81234),g=i(26860),$=i(32610),r=i(25693),t=i(36484),m=i(32639),o=i(42032),M=i(84708),S=i(10296),U=i(99927),Q=i(9280);let V=(()=>{class P{constructor(n,e,_,l,c,v,a,d,p){this.docxService=n,this.commonService=e,this.userService=_,this.questionRenderService=l,this.printAnswersheetService=c,this.formatAnswerSheetService=v,this.shareFileFlutterService=a,this.sAztAnswerTypeService=d,this.documentConfigService=p,this.configRenderService=new K.y,this.saveLoadingMsg="",this.isAnsDetail=!1,this.isEnableDebug=!1,this.zipper=new s,this.countRetryLoadJS=0}convertAnswerQuestion(n,e){let _=[],l=[];return n.answerResult&&this.isAnsDetail&&n.answerResult.forEach(c=>{let v=c;const a=n.answers?.find(d=>d.key===c);a&&(v=a.alpha??v),l.push(v)}),n.answers.forEach(c=>{let v="<b>     "+(l.includes(c.alpha??c.key)?"*":"")+(e?(c.alpha?c.alpha:c.key).toLowerCase()+")":(c.alpha?c.alpha:c.key)+".")+"</b> "+(0,F.t5)(c.content);_.push(v)}),_}getDataForExportDocxApi(n,e,_){let l=[],c=0;if(_){let a=this.commonService.myTranslateInstant("lang_cms_publish_test_exam");l.push({content:`<b> ${a} `+this.formatAnswerSheetService.formatOfflineExamHashIdToNumber(_,3)+".</b>",answers:[]})}let v=this.expandInfoParse?.label??this.commonService.myTranslateInstant("lang_auto_cau");return e.forEach(a=>{1!==n.hideGroupQuestion&&a.groupInfo?.isFirstInGroup&&a.groupInfo.groupContent&&l.push({content:`<b>${a.groupInfo.groupContent}<b>`,answers:[]}),this.isEnableDebug&&l.push({content:` <br/><br/><br/>*** <b>Question ID: ${a.id}</b> ***`,answers:[]});let d={content:`<b>${v} `+((a.labelIndex??c)+(n.startQuestionIndex??1))+".</b> "+(this.checkImgAtStart(a.content??"")?"<br/>":"")+(0,F.t5)(a.content),answers:this.convertAnswerQuestion(a??[],this.sAztAnswerTypeService.isTrueFalseAnswer(a))};if(c++,l.push(d),this.isAnsDetail&&((a.help||this.sAztAnswerTypeService.isFillAnswer(a))&&l.push({content:`<b>${this.commonService.myTranslateInstant("lang_auto_loi_giai")}</b><br/> ${a.help}`,answers:[]}),a.answerResult&&this.isAnsDetail)){let p=[];a.answerResult.forEach(O=>{let h=O;const I=a.answers?.find(D=>D.key===O);I&&(h=I.alpha??h),p.push(h)}),this.sAztAnswerTypeService.isFillAnswer(a)&&l.push({content:`${this.commonService.myTranslateInstant("lang_auto_dap_an")}: ${p.join(" | ")}`,answers:[]})}this.isEnableDebug&&l.push({content:"*** *************** .. **************** ***<br/><br/><br/>",answers:[]})}),l}itemConverterCaller(n,e,_,l,c){var v=this;return new Promise((a,d)=>{var p=0;this.questionRenderService.parseRenderQuestions(n.listQuestion,O=>{if(!this.saveLoadingMsg.includes(")")){p=O/2;var h=(this.commonService.myTranslateInstant("lang_cms_common_loading")??"")+Math.floor(p)+"%";this.changeMsg?this.changeMsg(h):C.L.changeMsgLoadingEffect(h)}},this.configRenderService,void 0,!0,c).then(O=>{let h=[];const I=[];if(e.examName&&I.push(F.$s.createLineCenterBold(e.examName)),e.subject&&I.push(F.$s.createLineCenterBold(e.subject)),e.examMinutes&&I.push(F.$s.createLineCenterItalicized(e.examMinutes)),I.push(F.$s.createLineCenterItalicized("-------------------------")),h.push({content:F.$s.makeHeaderTable([F.$s.createLineCenterBold(e.schoolName?e.schoolName:"")],I,!1),answers:[]}),h.push({content:F.$s.createLineBold(this.commonService.myTranslateInstant("lang_auto_ho_ten_thi_sinh_offline")??"").outerHTML,answers:[]}),h.push({content:F.$s.createLineBold(this.commonService.myTranslateInstant("lang_auto_so_bao_danh_offline")??"").outerHTML,answers:[]}),h=h.concat(this.getDataForExportDocxApi(l,O,n.offlineExamMixQuestionObj?n.offlineExamMixQuestionObj.hashId??0:void 0)),typeof azotaDocx<"u"&&azotaDocx){var D=0;let L=n.offlineExamMixQuestionObj?.hashId?n.offlineExamMixQuestionObj.hashId.toString().padStart(3,"0"):void 0,b=L?this.commonService.myTranslateInstant("lang_auto_ma_de")+" "+L:"";this.docxService.exportToDocxBinary(h,{isHeadless:!0,footerLeft:b},function(){var A=(0,T.A)(function*(E,u,f){new Promise(x=>{setTimeout(()=>{0==E&&(D=p),p=E/u*25+D;var N=(v.commonService.myTranslateInstant("lang_cms_common_loading")??"")+Math.floor(p)+"%";C.L.changeMsgLoadingEffect(N)}),x(!0)})});return function(E,u,f){return A.apply(this,arguments)}}()).then(A=>{a({userObj:_,data:A,input:h,additionParams:e,offlineExamMixQuestionObj:n.offlineExamMixQuestionObj})})}else d(new Error("C\xf3 l\u1ed7i x\u1ea3y ra trong qu\xe1 tr\xecnh x\u1eed l\xfd d\u1eef li\u1ec7u (Kh\xf4ng t\u1ea3i \u0111\u01b0\u1ee3c th\u01b0 vi\u1ec7n). Vui l\xf2ng F5 v\xe0 th\u1eed l\u1ea1i sau!"))}).catch(O=>{d(new Error(O[0].message))})})}masterConverterCaller(n,e,_,l,c,v){return new Promise((a,d)=>{const p=this.userService.getUserObj();let O=this.commonService.myTranslateInstant("lang_testbank_utils_footer_information_school")?.toLowerCase(),h=this.commonService.myTranslateInstant("lang_auto_docx_mon_thi")?.toLowerCase(),I=this.commonService.myTranslateInstant("lang_auto_docx_bai_thi")?.toLowerCase(),D=this.commonService.myTranslateInstant("lang_testbank_tested_list_time_homework"),L=this.commonService.myTranslateInstant("lang_core_khong_ke_thoi_gian_giao_de"),b=this.commonService.myTranslateInstant("lang_testbank_tested_list_minute"),A=this.commonService.myTranslateInstant("lang_auto_khong_gioi_han");const E=new R.n(1,{function:(u,f)=>{this.saveLoadingMsg=`${this.commonService.myTranslateInstant("lang_auto_dang_tao_tep_tin_cho_de_thi")} ${f<=1?"":`(${u}/${f}) `}`,this.changeMsg?this.changeMsg(this.saveLoadingMsg):C.L.changeMsgLoadingEffect(this.saveLoadingMsg)}});n.forEach(u=>{E.addTask(this,this.itemConverterCaller,[u,{schoolName:l?.nameSchool??`{${O}}`,subject:l?.nameSubject??`{${h}}`,examName:e.name??`{${I}}`,examMinutes:e.minutes&&e.minutes>0?`${D}: `+e.minutes+` ${b} (${L})`:` ${D}: ${A}`,templateType:c??0,numberOfQuestion:u.listQuestion.length,examId:u.offlineExamMixQuestionObj?.hashId??0},p,e,v])}),E.start().then(u=>{if(u.errs.length>0)d(u.errs[0]);else if(1===u.datas.length){const f=u.datas[0],x=new Blob([f.data],{type:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"});let N=this.createNameExam(e,_,f.offlineExamMixQuestionObj);this.shareFileFlutterService.shareFileWithBlob(x,N),a()}else u.datas.forEach(f=>{let x=this.createNameExam(e,_,f.offlineExamMixQuestionObj);x=this.replaceAllString(x,"/","_"),this.zipper.file("DOCS/"+x,f.data)}),setTimeout(()=>{this.zipper.generateAsync({type:"blob"}).then(f=>{let x=this.commonService.createFileNameExportFile([e.name??"azota"])+"_offline_test.zip";this.shareFileFlutterService.shareFileWithBlob(f,x),a()},f=>{d(f)})},200)})})}replaceAllString(n,e,_){for(;n.includes(e);)n=n.replace(e,_);return n}createNameExam(n,e,_){return e?this.printAnswersheetService.exportFileNameOfExamOffline(0,n.name??"",e?.hashId??"",_?.hashId??0)+".docx":this.printAnswersheetService.exportFileNameOfRawExam(0,n.name??"",n.hashId??"")+".docx"}downloadExam(n,e,_,l,c,v,a,d,p,O,h){return new Promise((I,D)=>{this.isAnsDetail=n,this.isEnableDebug=!!O,this.expandInfoParse=this.commonService.castJsonToObj(e.expandInfo??"{}"),this.changeMsg=p,this.commonService.loadAzotaDocxJs().then(()=>{this.documentConfigService.apiDocumentConfigGetExamConfigDataV2Get(e.hashId??"").subscribe(L=>{if(1==L.success){let b=0,A=0;c.forEach((E,u)=>{E.labelIndex=u,L.data?.resetQuestionIndex&&E.groupInfo&&E.groupInfo.groupId&&(b!=E.groupInfo.groupId&&(b=E.groupInfo.groupId,A=0),E.labelIndex=A,A++)})}this.masterConverterCaller([{listQuestion:c,offlineExamMixQuestionObj:l}],e,_,v,a,h).then(()=>{this.zipper=new s,d?d(10):C.L.closeLoadingEffect(10),I()}).catch(b=>{C.L.closeLoadingEffect(10),D(b)})})}).catch(()=>{d?d(10):C.L.closeLoadingEffect(10),D(new Error("lang_core_lib_not_load"))})})}downloadExamObjs(n,e,_,l,c,v,a,d,p,O){return new Promise((h,I)=>{this.isAnsDetail=n,this.isEnableDebug=!!p,this.expandInfoParse=this.commonService.castJsonToObj(e.expandInfo??"{}"),this.changeMsg=d,this.commonService.loadAzotaDocxJs().then(()=>{let D=!0;const L=[];this.documentConfigService.apiDocumentConfigGetExamConfigDataV2Get(e.hashId??"").subscribe(b=>{l.forEach(A=>{let E=this.commonService.castJsonToClassObjs(B.I,JSON.stringify(A.mixQuestions??[]))??[];if(E.length>0){if(1==b.success){let u=0,f=0;E.forEach((x,N)=>{x.labelIndex=N,b.data?.resetQuestionIndex&&x.groupInfo&&x.groupInfo.groupId&&(u!=x.groupInfo.groupId&&(u=x.groupInfo.groupId,f=0),x.labelIndex=f,f++)})}L.push({listQuestion:E,offlineExamMixQuestionObj:A})}else D=!1}),D?this.masterConverterCaller(L,e,_,c,v,O).then(()=>{this.zipper=new s,a?a(10):C.L.closeLoadingEffect(10),h()}).catch(A=>{a?a(10):C.L.closeLoadingEffect(10),I(A)}):(a?a(10):C.L.closeLoadingEffect(10),I(new Error("lang_testbank_exam_is_invalid_condition")))})}).catch(()=>{a?a(10):C.L.closeLoadingEffect(10),I(new Error("lang_core_lib_not_load"))})})}checkImgAtStart(n){return/^\s*<img/.test(n)}static#e=this.\u0275fac=function(e){return new(e||P)(g.KVO($.I),g.KVO(r.R),g.KVO(t.R),g.KVO(m.g),g.KVO(o.Q),g.KVO(M.e),g.KVO(S.R),g.KVO(U._),g.KVO(Q.x_))};static#t=this.\u0275prov=g.jDH({token:P,factory:P.\u0275fac,providedIn:"root"})}return P})()}}]);